<!DOCTYPE html>
<html>

<head>
  <title>V2Sign</title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script>
    var worker = new Worker('work.js');
    worker.onmessage = (event) => {
      eval(`${event.data[0]}`)(event.data[1]);
    }

    function ele(i) {
      return document.getElementById(i);
    }
  </script>
</head>

<body>
  <h1>V2Sign</h1>
  <p>生成签名验证身份，</p>
  <p>1. 本地自动异步创建rsa公私钥， <span id="step1"></span>
    <a id="btnShowKey" href="javascript:ele('dKey').hidden = false" type="button" hidden>显示密钥</a>
    <div id='dKey' hidden>
      私钥：<textarea rows="3" cols="64" id="privateKey" disabled></textarea><br>
      公钥：<textarea rows="3" cols="64" id="publicKey" disabled></textarea>
    </div>
    <script>
      var pem;
      ele('step1').innerText = '正在创建...';
      generate = function (arg) {
        pem = arg;
        ele('privateKey').value = pem.privateKey;
        ele('publicKey').value = pem.publicKey;
        ele('step1').innerText = 'OK';
        ele('btnShowKey').hidden = false;
      }
      worker.postMessage(['generate']);
    </script>
    <div>
      <p>2. 填写要验证的资料， <span id="step2"></span></p>
      V2EX ID: <input type="text" id="v2Id"><br>
      ns好友码: <input type="text" id="nsCode"><br>
      接收邀请邮箱: <input type="text" id="email"><br>
      拼接后: <input type="text" id="content" disabled><br>
      <script>
        var v2Id = ele("v2Id");
        var nsCode = ele("nsCode");
        var email = ele("email");
        var content = ele("content");

        function onInputChange() {
          content.value = v2Id.value.replace(/\s/g, '') +
            nsCode.value.replace(/[^\d]/g, '') +
            email.value.replace(/\s/g, '');
        }
        [v2Id, nsCode, email].forEach((e) => {
          e.addEventListener('input', onInputChange);
        })
      </script>
      <input type="button" value="本地签名并上传获取服务器签名" onclick="clickUpload()"><br>
      <script>
        var localSign;
        sign = function (s) {
          localSign = s;
          ele('localSign').value = s;
          callUpload();
        }

        function clickUpload() {
          ele('step2').innerText = '正在进行本地签名...';
          worker.postMessage(['sign', content.value])
        }
      </script>
      本地签名: <input type="text" id="localSign" disabled><br>
      <script>
        var serverSign;

        function callUpload() {
          ele('step2').innerText = '正在上传并等待服务器签名...';
          upload = function (s) {
            serverSign = s;
            ele('serverSign').value = s;
            ele('step2').innerText = '上传完成并显示服务器签名';
          }
          worker.postMessage(['upload', [v2Id.value, nsCode.value, email.value, localSign, pem.publicKey]])
        }
      </script>
      服务器签名: <textarea rows="3" cols="64" id="serverSign" disabled></textarea><br>
    </div>
    <div>
      <p>3. 复制签名回帖，或者可以验证一下签名， <span id="step3"></span></p>
      <input type="button" value="复制签名" onclick="onCopy()">
      <script>
        function onCopy() {
          ele('serverSign').disabled = false;
          ele('serverSign').select();
          document.execCommand("Copy");
          ele('step3').innerText = '已复制';
          ele('serverSign').disabled = true;
        }
      </script>
      <input type="button" value="验证签名" onclick="onCheckSign()">
      <script>
        function onCheckSign() {
          console.log("onCheckSign");
        }
      </script>
    </div>
</body>

</html>