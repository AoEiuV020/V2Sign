<!DOCTYPE html>
<html>

<head>
  <title>V2Sign</title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script>
    var worker = new Worker('work.js');
    worker.onmessage = (event) => {
      eval(`${event.data[0]}`)(event.data[1]);
    }

    function ele(i) {
      return document.getElementById(i);
    }
  </script>
</head>

<body>
  <h1>V2Sign</h1>
  <p>生成签名验证身份，</p>
  <p>1. 本地自动异步创建rsa公私钥， <span id="step1"></span>
    <a id="btnShowKey" href="javascript:ele('dKey').hidden = false;ele('btnShowKey').hidden = true" type="button"
      hidden>显示密钥</a>
  </p>
  <div id='dKey' hidden>
    私钥：<br><textarea rows="3" cols="64" id="privateKey" disabled></textarea><br>
    公钥：<br><textarea rows="3" cols="64" id="publicKey" disabled></textarea>
  </div>
  <script>
    var pem;

    function callInitKey() {
      ele('step1').innerText = '正在创建密钥...';
      pem = {
        privateKey: localStorage.getItem('localPrivateKey'),
        publicKey: localStorage.getItem('localPublicKey'),
      };

      function onPemUpdate(arg) {
        pem = arg;
        localStorage.setItem('localPrivateKey', pem.privateKey);
        localStorage.setItem('localPublicKey', pem.publicKey);
        ele('privateKey').value = pem.privateKey;
        ele('publicKey').value = pem.publicKey;
        ele('step1').innerText = 'OK';
        ele('btnShowKey').hidden = false;
      }
      if (pem.privateKey && pem.publicKey) {
        importPem = function (arg) {
          onPemUpdate(arg);
        }
        worker.postMessage(['importPem', pem]);
      } else {
        generate = function (arg) {
          onPemUpdate(arg);
        }
        worker.postMessage(['generate']);
      }
    }
    window.onload = callInitKey;
  </script>
  <div>
    <p>2. 填写要验证的资料， <span id="step2"></span>
      <a id="btnShowServerKey" href="javascript:ele('dServerKey').hidden = false;ele('btnShowServerKey').hidden = true"
        type="button" hidden>显示服务器密钥</a>
    </p>
    V2EX ID: <input type="text" id="v2Id"><br>
    ns好友码: <input type="text" id="nsCode"><br>
    接收邀请邮箱: <input type="text" id="email"><br>
    拼接后: <input type="text" id="content" disabled><br>
    <script>
      var v2Id = ele("v2Id");
      var nsCode = ele("nsCode");
      var email = ele("email");
      var content = ele("content");

      v2Id.value = localStorage.getItem('v2Id');
      nsCode.value = localStorage.getItem('nsCode');
      email.value = localStorage.getItem('email');

      function onInputChange() {
        content.value = v2Id.value.replace(/\s/g, '') +
          nsCode.value.replace(/[^\d]/g, '') +
          email.value.replace(/\s/g, '');
      }
      onInputChange();
      [v2Id, nsCode, email].forEach((e) => {
        e.addEventListener('input', onInputChange);
      })
    </script>
    <input type="button" value="本地签名并上传获取服务器签名" onclick="clickUpload()"><br>
    本地签名: <input type="text" id="localSign" disabled><br>
    <script>
      var localSign = localStorage.getItem('localSign');
      if (localSign) {
        ele('localSign').value = localSign;
      }
      sign = function (s) {
        localSign = s;
        localStorage.setItem('localSign', localSign);
        ele('localSign').value = s;
        callUpload();
      }

      function clickUpload() {
        if (!v2Id.value && !nsCode.value && !email.value) {
          return;
        }
        if (localStorage.getItem('serverSignHash') && !confirm('重复上传将覆盖旧数据，只有最后一次上传有效，\n是否确认上传？')) {
          return;
        }
        localStorage.setItem('v2Id', v2Id.value);
        localStorage.setItem('nsCode', nsCode.value);
        localStorage.setItem('email', email.value);
        localStorage.setItem('content', content.value);
        ele('step2').innerText = '正在进行本地签名...';
        worker.postMessage(['sign', content.value])
      }
    </script>
    服务器签名: <input type="text" id="serverSign" disabled><br>
    <div id="dServerKey" hidden>
      服务器公钥: <br><textarea rows="3" cols="64" id="serverPublicKey" disabled></textarea><br>
    </div>
    <script>
      var serverSign = localStorage.getItem('serverSign');
      if (serverSign) {
        ele('serverSign').value = serverSign;
      }
      var serverPublicKey = localStorage.getItem('serverPublicKey');
      if (serverPublicKey) {
        ele('serverPublicKey').value = serverPublicKey;
        ele('btnShowServerKey').hidden = false;
      }

      function callUpload() {
        ele('step2').innerText = '正在上传并等待服务器签名...';
        upload = function (res) {
          let {
            status,
            body
          } = res;
          if (status != 200) {
            ele('serverSign').value = '失败: ' + status;
            if (status % 100 == 4) {
              ele('step2').innerText = '上传失败！？';
            } else if (status % 100 == 5) {
              ele('step2').innerText = '服务器签名失败！？';
            }
          } else {
            serverSign = body.signature;
            serverPublicKey = body.publicKey;
            localStorage.setItem('serverSign', serverSign);
            localStorage.setItem('serverPublicKey', serverPublicKey);
            ele('serverSign').value = serverSign;
            ele('serverPublicKey').value = serverPublicKey;
            ele('btnShowServerKey').hidden = false;
            callHash();
          }
        }
        worker.postMessage(['upload', [v2Id.value, nsCode.value, email.value, localSign, pem.publicKey]])
      }
    </script>
    签名摘要: <input type="text" id="serverSignHash" disabled><br>
    <script>
      var serverSignHash = localStorage.getItem('serverSignHash');
      if (serverSignHash) {
        ele('serverSignHash').value = serverSignHash;
      }

      function callHash() {
        ele('step2').innerText = '计算服务器签名摘要...';
        hash = function (text) {
          serverSignHash = text;
          localStorage.setItem('serverSignHash', serverSignHash);
          ele('serverSignHash').value = serverSignHash;
          ele('step2').innerText = '上传完成并显示服务器签名摘要';
        }
        worker.postMessage(['hash', serverSign])
      }
    </script>
  </div>
  <div>
    <p>3. 复制签名摘要回帖，或者可以验证一下签名， <span id="step3"></span></p>
    <input type="button" value="复制签名" onclick="onCopy()">
    <script>
      function onCopy() {
        ele('serverSignHash').disabled = false;
        ele('serverSignHash').select();
        document.execCommand("Copy");
        ele('step3').innerText = '已复制';
        ele('serverSignHash').disabled = true;
      }
    </script>
    <input type="button" value="验证签名" onclick="onCheckSign()">
    <script>
      function onCheckSign() {
        console.log("onCheckSign");
      }
    </script>
  </div>
</body>

</html>