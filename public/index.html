<!DOCTYPE html>
<html>

<head>
  <title>V2Sign</title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script>
    var worker = new Worker('work.js');
    worker.onmessage = (event) => {
      console.log("ui.onMessage: " + event.data);
      eval(`${event.data[0]}`)(event.data[1]);
    }

    function ele(i) {
      return document.getElementById(i);
    }
  </script>
</head>

<body>
  <h1>V2Sign</h1>
  <p>生成签名验证身份，</p>
  <p>1. 本地自动异步创建rsa公私钥<span id="step1">中...</span>
    <a id="btnShowKey" href="javascript:ele('dKey').hidden = false" type="button" hidden>显示密钥</a>
    <div id='dKey' hidden>
      私钥：<textarea rows="3" cols="64" id="privateKey" disabled></textarea><br>
      公钥：<textarea rows="3" cols="64" id="publicKey" disabled></textarea>
    </div>
    <script>
      var pem;
      generate = function (arg) {
        pem = arg;
        ele('privateKey').value = pem.privateKey;
        ele('publicKey').value = pem.publicKey;
        ele('step1').innerText = 'OK';
        ele('btnShowKey').hidden = false;
      }
      worker.postMessage(['generate']);
    </script>
    <div>
      <p>2. 填写要验证的资料</p>
      V2EX ID: <input type="text" id="v2Id"><br>
      ns好友码: <input type="text" id="nsCode"><br>
      接收邀请邮箱: <input type="text" id="email"><br>
      拼接后: <input type="text" id="content" disabled><br>
      <script>
        var v2Id = ele("v2Id");
        var nsCode = ele("nsCode");
        var email = ele("email");
        var content = ele("content");

        function onInputChange() {
          content.value = v2Id.value.replaceAll(/\s/g, '') +
            nsCode.value.replaceAll(/[^\d]/g, '') +
            email.value.replaceAll(/\s/g, '');
        }
        [v2Id, nsCode, email].forEach((e) => {
          e.addEventListener('input', onInputChange);
        })
      </script>
      <input type="button" value="本地签名并上传获取服务器签名" onclick="clickUpload()"><br>
      <script>
        var localSign;
        sign = function (s) {
          localSign = s;
          ele('localSign').value = s;
          callUpload();
        }

        function clickUpload() {
          worker.postMessage(['sign', content.value])
        }
      </script>
      本地签名后: <input type="text" id="localSign" disabled><br>
      <script>
        var serverSign;

        function callUpload() {
          upload = function (s) {
            serverSign = s;
            ele('serverSign').value = s;
          }
          worker.postMessage(['upload', [v2Id.value, nsCode.value, email.value, localSign, pem.publicKey]])
        }
      </script>
      服务器签名后: <input type="text" id="serverSign" disabled><br>
    </div>
    <div>
      <p>3. 复制签名回帖，或者可以验证一下签名，</p>
      <input type="button" value="复制签名" onclick="onCopy()">
      <script>
        function onCopy() {
          console.log("onCopy");
        }
      </script>
      <input type="button" value="验证签名" onclick="onCheckSign()">
      <script>
        function onCheckSign() {
          console.log("onCheckSign");
        }
      </script>
    </div>
</body>

</html>